<!DOCTYPE html>
<html>
<head>
    <title>Cooperative Yielding - All Loop Types Test</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; margin-top: 30px; }

        #animation-container {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 8px;
        }

        #animation-bar {
            width: 100%;
            height: 40px;
            background: linear-gradient(90deg, #4ec9b0 0%, #569cd6 100%);
            border-radius: 4px;
            transition: transform 0.1s;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-left: 4px solid #007acc;
            border-radius: 4px;
        }

        .code-block {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre;
            font-size: 13px;
            overflow-x: auto;
        }

        .output {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .stat-box {
            padding: 15px;
            background: #2d2d30;
            border-radius: 4px;
            border-left: 3px solid #4ec9b0;
        }

        .stat-label {
            color: #858585;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat-value {
            color: #4ec9b0;
            font-size: 24px;
            font-weight: bold;
        }

        .pass { color: #4ec9b0; }
        .fail { color: #f48771; }
        .info { color: #569cd6; }

        button {
            background: #0e639c;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
        }

        #summary {
            margin: 20px 0;
            padding: 20px;
            background: #2d2d30;
            border-radius: 4px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>Cooperative Yielding - All Loop Types Test</h1>

    <div id="animation-container">
        <h3>Browser Responsiveness Indicator</h3>
        <div id="animation-bar"></div>
        <p class="info">If this bar animates smoothly, the browser is not frozen!</p>
    </div>

    <div id="summary">Loading CircuitPython WASM...</div>

    <div id="tests-container"></div>

    <script type="module">
        import { loadCircuitPython } from '../build-standard/circuitpython.mjs';
        import { CooperativeSupervisor } from '../src/core/cooperative_supervisor.js';

        // Animation to prove browser isn't frozen
        let animationPos = 0;
        setInterval(() => {
            animationPos = (animationPos + 1) % 100;
            const bar = document.getElementById('animation-bar');
            if (bar) {
                bar.style.transform = `translateX(${animationPos}%)`;
            }
        }, 16); // ~60fps

        const testCases = [
            {
                name: 'Test 1: while True loop',
                code: `counter = 0
while True:
    print(f"Iteration {counter}")
    counter += 1`,
                timeout: 10000,
                expectedYields: 270 // Approx 100 iterations per yield, ~27-28 yields in 10s
            },
            {
                name: 'Test 2: while condition loop',
                code: `x = 0
while x >= 0:  # Infinite loop with condition
    print(f"x = {x}")
    x += 1`,
                timeout: 10000,
                expectedYields: 270
            },
            {
                name: 'Test 3: for loop (infinite generator)',
                code: `def infinite_gen():
    i = 0
    while True:
        yield i
        i += 1

for val in infinite_gen():
    print(f"Value: {val}")`,
                timeout: 10000,
                expectedYields: 270
            },
            {
                name: 'Test 4: Multiple nested loops',
                code: `outer = 0
while True:
    print(f"Outer {outer}")
    inner = 0
    while inner < 5:  # Finite inner loop
        print(f"  Inner {inner}")
        inner += 1
    outer += 1`,
                timeout: 10000,
                expectedYields: 270
            },
            {
                name: 'Test 5: for loop with large range',
                code: `for i in range(100000):  # Very large finite range
    print(f"i = {i}")`,
                timeout: 10000,
                expectedYields: 270
            }
        ];

        async function runTest(supervisor, testCase, index) {
            const container = document.getElementById('tests-container');
            const section = document.createElement('div');
            section.className = 'test-section';
            section.id = `test-${index}`;

            let html = `<h2>${testCase.name}</h2>`;
            html += `<div class="code-block">${testCase.code}</div>`;
            html += `<div class="stats">`;
            html += `<div class="stat-box"><div class="stat-label">Yields</div><div class="stat-value" id="yields-${index}">0</div></div>`;
            html += `<div class="stat-box"><div class="stat-label">Iterations</div><div class="stat-value" id="iterations-${index}">0</div></div>`;
            html += `<div class="stat-box"><div class="stat-label">Status</div><div class="stat-value info" id="status-${index}">Running...</div></div>`;
            html += `</div>`;
            html += `<div class="output" id="output-${index}"></div>`;

            section.innerHTML = html;
            container.appendChild(section);

            const outputDiv = document.getElementById(`output-${index}`);
            const yieldsDiv = document.getElementById(`yields-${index}`);
            const iterationsDiv = document.getElementById(`iterations-${index}`);
            const statusDiv = document.getElementById(`status-${index}`);

            let outputLines = [];
            let yieldCount = 0;
            let iterationCount = 0;

            // Capture console output
            const originalLog = console.log;
            console.log = (...args) => {
                const line = args.join(' ');
                outputLines.push(line);
                if (outputLines.length > 50) {
                    outputLines.shift(); // Keep last 50 lines
                }
                outputDiv.innerHTML = outputLines.map(l => `<div>${l}</div>`).join('');
                outputDiv.scrollTop = outputDiv.scrollHeight;
                originalLog(...args);
            };

            try {
                await supervisor.runWithYielding(testCase.code, {
                    timeout: testCase.timeout,
                    onYield: (info) => {
                        yieldCount = info.yieldCount;
                        iterationCount = info.iterations;
                        yieldsDiv.textContent = yieldCount;
                        iterationsDiv.textContent = iterationCount;
                    },
                    onComplete: (result) => {
                        console.log = originalLog;

                        if (result?.timedOut) {
                            statusDiv.textContent = 'Timeout';
                            statusDiv.className = 'stat-value pass';

                            // Check if we got reasonable yields
                            const withinRange = yieldCount >= testCase.expectedYields * 0.9 &&
                                              yieldCount <= testCase.expectedYields * 1.1;

                            if (withinRange) {
                                section.style.borderLeftColor = '#4ec9b0'; // Green
                            } else {
                                section.style.borderLeftColor = '#dcdcaa'; // Yellow - worked but unexpected yield count
                            }
                        } else {
                            statusDiv.textContent = 'Complete';
                            statusDiv.className = 'stat-value pass';
                            section.style.borderLeftColor = '#4ec9b0';
                        }
                    },
                    onError: (error) => {
                        console.log = originalLog;
                        statusDiv.textContent = 'Error';
                        statusDiv.className = 'stat-value fail';
                        section.style.borderLeftColor = '#f48771'; // Red
                        console.error('Test error:', error);
                    }
                });
            } catch (error) {
                console.log = originalLog;
                statusDiv.textContent = 'Error';
                statusDiv.className = 'stat-value fail';
                section.style.borderLeftColor = '#f48771';
                console.error('Test exception:', error);
            }
        }

        async function runAllTests() {
            try {
                const cp = await loadCircuitPython({
                    verbose: false,
                    stdout: (line) => {
                        // CircuitPython output
                    }
                });

                console.log('CircuitPython loaded successfully');

                const supervisor = new CooperativeSupervisor(cp);

                const summary = document.getElementById('summary');
                summary.innerHTML = '<span class="info">Running tests...</span>';

                // Run tests sequentially
                for (let i = 0; i < testCases.length; i++) {
                    await runTest(supervisor, testCases[i], i);
                }

                summary.innerHTML = '<span class="pass">âœ“ All tests completed!</span>';

            } catch (error) {
                document.getElementById('summary').innerHTML =
                    `<span class="fail">Failed to load CircuitPython: ${error.message}</span>`;
                console.error('Setup error:', error);
            }
        }

        runAllTests();
    </script>
</body>
</html>
