<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooperative Yielding Test v2</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; margin-top: 20px; }
        .panel {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .console {
            background: #0c0c0c;
            color: #cccccc;
            padding: 10px;
            border-radius: 3px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            font-family: monospace;
        }
        .button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background: #1177bb; }
        .button:disabled {
            background: #3c3c3c;
            cursor: not-allowed;
        }
        .stats {
            background: #2d2d30;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
        .stats div {
            margin: 5px 0;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        #animation-indicator {
            width: 100%;
            height: 30px;
            background: linear-gradient(90deg, #0e639c 0%, #1177bb 50%, #0e639c 100%);
            background-size: 200% 100%;
            animation: slide 2s linear infinite;
            border-radius: 3px;
            margin: 10px 0;
        }
        @keyframes slide {
            0% { background-position: 0% 0; }
            100% { background-position: 200% 0; }
        }
    </style>
</head>
<body>
    <h1>üêç Cooperative Yielding Test v2</h1>

    <div class="panel">
        <h2>Animation Test (proves non-blocking execution)</h2>
        <div id="animation-indicator"></div>
        <p>If this bar animates smoothly while Python is running, cooperative yielding is working!</p>
    </div>

    <div class="panel">
        <h2>Test Controls</h2>
        <button class="button" onclick="runSimpleTest()" id="test1">Test 1: Simple Print</button>
        <button class="button" onclick="runLoopTest()" id="test2">Test 2: Loop (10 iterations)</button>
        <button class="button" onclick="runInfiniteTest()" id="test3">Test 3: Infinite Loop (with yielding)</button>
        <button class="button" onclick="stopTest()" id="stop-btn" disabled>‚èπÔ∏è Stop</button>
        <button class="button" onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="panel">
        <h2>Statistics</h2>
        <div class="stats" id="stats">
            <div>Status: <span id="status">Loading...</span></div>
            <div>Yield Count: <span id="yield-count">0</span></div>
            <div>Iterations: <span id="iterations">0</span></div>
            <div>Frame Time: <span id="frame-time">0ms</span></div>
        </div>
    </div>

    <div class="panel">
        <h2>Console Output</h2>
        <div class="console" id="console"></div>
    </div>

    <script type="module">
        import { createSupervisor } from '../src/core/cooperative_supervisor.js';

        let wasmModule = null;
        let supervisor = null;
        let running = false;
        let frameTimeStart = 0;
        let stopRequested = false;

        // Console logging
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.style.color = type === 'error' ? '#f48771' :
                              type === 'success' ? '#4ec9b0' :
                              type === 'warning' ? '#dcdcaa' : '#cccccc';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        window.log = log;

        function clearConsole() {
            document.getElementById('console').innerHTML = '';
        }
        window.clearConsole = clearConsole;

        // Load CircuitPython WASM
        async function loadWASM() {
            try {
                log('Loading CircuitPython WASM module...', 'info');

                const { loadCircuitPython } = await import('../build-standard/circuitpython.mjs');

                wasmModule = await loadCircuitPython({
                    heapsize: 512 * 1024,
                    stdout: (line) => log(`>>> ${line}`, 'success'),
                    stderr: (line) => log(`!!! ${line}`, 'error'),
                    verbose: false
                });

                // Create the cooperative supervisor
                supervisor = createSupervisor(wasmModule);

                log('CircuitPython WASM loaded successfully!', 'success');
                log('Cooperative supervisor initialized!', 'success');
                document.getElementById('status').textContent = 'Ready';
                document.getElementById('status').className = 'success';

                // Start frame time tracking
                trackFrameTime();

            } catch (e) {
                log(`Failed to load: ${e}`, 'error');
                console.error(e);
                document.getElementById('status').textContent = 'Failed';
                document.getElementById('status').className = 'error';
            }
        }

        // Track frame time to show responsiveness
        function trackFrameTime() {
            frameTimeStart = performance.now();
            requestAnimationFrame(() => {
                const frameTime = performance.now() - frameTimeStart;
                document.getElementById('frame-time').textContent = `${frameTime.toFixed(1)}ms`;
                trackFrameTime();
            });
        }

        // Test 1: Simple print (no yielding needed)
        window.runSimpleTest = function() {
            if (!supervisor) return;
            log('Running Test 1: Simple Print', 'warning');

            try {
                supervisor.runSafe('print("Hello from CircuitPython WASM!")');
                log('Test 1 completed!', 'success');
            } catch (e) {
                log(`Test 1 failed: ${e}`, 'error');
            }
        };

        // Test 2: Loop (no infinite loop)
        window.runLoopTest = function() {
            if (!supervisor) return;
            log('Running Test 2: Loop (10 iterations)', 'warning');

            const code = `
for i in range(10):
    print(f"Iteration {i+1}/10")
print("Loop complete!")
`;

            try {
                supervisor.runSafe(code);
                log('Test 2 completed!', 'success');
            } catch (e) {
                log(`Test 2 failed: ${e}`, 'error');
            }
        };

        // Test 3: Infinite loop with yielding
        window.runInfiniteTest = async function() {
            if (!supervisor) return;
            log('Running Test 3: Infinite Loop (with cooperative yielding)', 'warning');
            log('Watch the animation bar - it should stay smooth!', 'warning');
            log('Click STOP to terminate', 'warning');

            document.getElementById('stop-btn').disabled = false;
            document.getElementById('test3').disabled = true;
            running = true;
            stopRequested = false;

            const code = `
counter = 0
while True:
    counter += 1
    if counter % 10 == 0:
        print(f"Counter: {counter}")
`;

            try {
                await supervisor.runWithYielding(code, {
                    onYield: ({ iterations, yieldCount }) => {
                        if (stopRequested) {
                            throw new Error('Stopped by user');
                        }
                        document.getElementById('yield-count').textContent = yieldCount;
                        document.getElementById('iterations').textContent = iterations;
                    },
                    onComplete: (result) => {
                        if (result?.timedOut) {
                            log('Test 3 timed out', 'warning');
                        } else {
                            log('Test 3 completed!', 'success');
                        }
                    },
                    onError: (e) => {
                        if (e.message.includes('Stopped by user')) {
                            log('Test 3 stopped by user', 'warning');
                        } else {
                            log(`Test 3 error: ${e}`, 'error');
                        }
                    },
                    timeout: 10000 // 10 second timeout for demo
                });
            } catch (e) {
                log(`Test 3 failed: ${e}`, 'error');
            } finally {
                running = false;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('test3').disabled = false;
            }
        };

        // Stop test
        window.stopTest = function() {
            log('Stop requested', 'warning');
            stopRequested = true;
            running = false;
        };

        // Initialize
        window.addEventListener('load', loadWASM);
    </script>
</body>
</html>
