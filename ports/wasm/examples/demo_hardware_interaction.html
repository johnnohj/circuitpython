<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircuitPython WASM - Hardware Interaction Demo</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 5px;
            padding: 15px;
        }
        .panel h2 {
            margin-top: 0;
            color: #569cd6;
        }
        #output {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            margin-bottom: 10px;
        }
        .hardware-viz {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .pin-viz {
            background-color: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 3px;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }
        .pin-viz.output {
            border-color: #569cd6;
        }
        .pin-viz.input {
            border-color: #4ec9b0;
        }
        .pin-viz.high {
            background-color: #4a4a0e;
        }
        .pin-label {
            font-weight: bold;
            color: #dcdcaa;
        }
        .pin-value {
            margin-top: 5px;
            padding: 3px;
            border-radius: 2px;
        }
        .controls button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .controls button:hover {
            background-color: #1177bb;
        }
        .controls button:disabled {
            background-color: #3e3e42;
            cursor: not-allowed;
        }
        code {
            background-color: #1e1e1e;
            padding: 2px 5px;
            border-radius: 3px;
            color: #ce9178;
        }
        .info {
            background-color: #1e1e1e;
            border-left: 3px solid #569cd6;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ðŸ”Œ CircuitPython WASM - Hardware Interaction Demo</h1>

    <div class="info">
        <strong>Architecture:</strong> WASM runs CircuitPython code autonomously with internal virtual hardware.
        JavaScript acts as the "external world" - simulating button presses and observing LED states.
    </div>

    <div class="container">
        <div class="panel">
            <h2>Python Code</h2>
            <div id="output"></div>
            <div class="controls">
                <button id="startBtn">Run Code</button>
                <button id="stopBtn" disabled>Stop</button>
            </div>
        </div>

        <div class="panel">
            <h2>Virtual Hardware State</h2>
            <p>JavaScript can observe outputs and inject inputs:</p>
            <div class="hardware-viz" id="pinViz"></div>
            <div class="controls">
                <button id="pressBtn2">Press Button D2</button>
                <button id="releaseBtn2">Release Button D2</button>
                <button id="pressBtn3">Press Button D3</button>
                <button id="releaseBtn3">Release Button D3</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loadCircuitPython } from './build-standard/circuitpython.mjs';

        const output = document.getElementById('output');
        const pinViz = document.getElementById('pinViz');
        let ctpy = null;
        let vizInterval = null;

        function log(msg) {
            const line = document.createElement('div');
            line.textContent = msg;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        // Python code that reads buttons and controls LEDs
        const pythonCode = `
import board
import digitalio
import time

print("Hardware Interaction Demo")
print("=" * 40)

# Setup LEDs (outputs)
led1 = digitalio.DigitalInOut(board.D13)
led1.direction = digitalio.Direction.OUTPUT
print("LED1 (D13) initialized as OUTPUT")

led2 = digitalio.DigitalInOut(board.D12)
led2.direction = digitalio.Direction.OUTPUT
print("LED2 (D12) initialized as OUTPUT")

# Setup buttons (inputs with pull-up)
btn2 = digitalio.DigitalInOut(board.D2)
btn2.direction = digitalio.Direction.INPUT
btn2.pull = digitalio.Pull.UP
print("Button D2 initialized as INPUT with PULL_UP")

btn3 = digitalio.DigitalInOut(board.D3)
btn3.direction = digitalio.Direction.INPUT
btn3.pull = digitalio.Pull.UP
print("Button D3 initialized as INPUT with PULL_UP")

print("\\nStarting loop - press buttons to control LEDs!")
print("D2 -> LED1, D3 -> LED2\\n")

# Main loop
for i in range(50):
    # Button is active-low (False when pressed)
    btn2_pressed = not btn2.value
    btn3_pressed = not btn3.value

    # Update LEDs based on buttons
    led1.value = btn2_pressed
    led2.value = btn3_pressed

    if btn2_pressed or btn3_pressed:
        status = []
        if btn2_pressed:
            status.append("D2:ON->LED1:ON")
        if btn3_pressed:
            status.append("D3:ON->LED2:ON")
        print(f"{i}: {' | '.join(status)}")

    time.sleep(0.1)

print("\\nDemo complete!")
led1.deinit()
led2.deinit()
btn2.deinit()
btn3.deinit()
`;

        // Visualize pin states
        function updateVisualization() {
            if (!ctpy) return;

            // Clear visualization
            pinViz.innerHTML = '';

            // Pins to visualize
            const pins = [
                { num: 13, label: 'D13 (LED1)' },
                { num: 12, label: 'D12 (LED2)' },
                { num: 2, label: 'D2 (BTN)' },
                { num: 3, label: 'D3 (BTN)' }
            ];

            pins.forEach(({ num, label }) => {
                const direction = ctpy._virtual_gpio_get_direction(num);
                const isOutput = direction === 1;

                let value, valueText;
                if (isOutput) {
                    value = ctpy._virtual_gpio_get_output_value(num);
                    valueText = value ? 'HIGH' : 'LOW';
                } else {
                    // For inputs, we'll check the pull setting
                    const pull = ctpy._virtual_gpio_get_pull(num);
                    valueText = pull === 1 ? 'PULL_UP' : pull === 2 ? 'PULL_DOWN' : 'FLOAT';
                    value = false; // We can't directly read input state from outside
                }

                const div = document.createElement('div');
                div.className = `pin-viz ${isOutput ? 'output' : 'input'} ${value ? 'high' : ''}`;
                div.innerHTML = `
                    <div class="pin-label">${label}</div>
                    <div class="pin-value">${isOutput ? 'OUT' : 'IN'}</div>
                    <div class="pin-value">${valueText}</div>
                `;
                pinViz.appendChild(div);
            });
        }

        // Simulate button press
        function pressButton(pin) {
            if (!ctpy) return;
            log(`JS: Simulating button press on D${pin}`);
            // Button is active-low, so press = False (0)
            ctpy._virtual_gpio_set_input_value(pin, false);
        }

        function releaseButton(pin) {
            if (!ctpy) return;
            log(`JS: Releasing button D${pin}`);
            // Release = True (pull-up)
            ctpy._virtual_gpio_set_input_value(pin, true);
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', async () => {
            document.getElementById('startBtn').disabled = true;
            output.innerHTML = '';
            log('Loading CircuitPython WASM...');

            try {
                ctpy = await loadCircuitPython({
                    stdout: (text) => {
                        text.split('\n').forEach(line => {
                            if (line.trim()) log('> ' + line);
                        });
                    },
                    stderr: (text) => {
                        text.split('\n').forEach(line => {
                            if (line.trim()) log('ERROR: ' + line);
                        });
                    }
                });

                log('CircuitPython loaded! Starting visualization...');
                log('');

                // Start visualization updates
                vizInterval = setInterval(updateVisualization, 100);
                updateVisualization();

                // Write and run the Python code
                ctpy.FS.writeFile('/code.py', pythonCode);

                setTimeout(() => {
                    ctpy.runFile('/code.py');
                    document.getElementById('stopBtn').disabled = false;
                    log('');
                    log('Try pressing the button controls above!');
                }, 500);

            } catch (error) {
                log('ERROR: ' + error.message);
                document.getElementById('startBtn').disabled = false;
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            if (vizInterval) {
                clearInterval(vizInterval);
                vizInterval = null;
            }
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            log('Stopped');
        });

        document.getElementById('pressBtn2').addEventListener('click', () => pressButton(2));
        document.getElementById('releaseBtn2').addEventListener('click', () => releaseButton(2));
        document.getElementById('pressBtn3').addEventListener('click', () => pressButton(3));
        document.getElementById('releaseBtn3').addEventListener('click', () => releaseButton(3));
    </script>
</body>
</html>
