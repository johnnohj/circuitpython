<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CircuitPython WASM - Filesystem Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #666;
            font-size: 18px;
        }
        textarea {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            resize: vertical;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        #file-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
        #file-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #file-list li:hover {
            background: #f5f5f5;
        }
        .file-name {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .file-size {
            color: #999;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>üêç CircuitPython WASM Filesystem Demo</h1>
    <p>This demo shows CircuitPython running in WebAssembly with persistent IndexedDB storage.</p>

    <div class="container">
        <div class="panel">
            <h2>üìù code.py Editor</h2>
            <textarea id="editor">import board
import time
import digitalio

# Blink example
led = digitalio.DigitalInOut(board.LED)
led.direction = digitalio.Direction.OUTPUT

print("Starting blink loop...")
for i in range(5):
    led.value = True
    print(f"LED ON  (iteration {i+1})")
    time.sleep(0.5)

    led.value = False
    print(f"LED OFF (iteration {i+1})")
    time.sleep(0.5)

print("Blink complete!")
</textarea>
            <div class="button-group">
                <button onclick="saveCode()">üíæ Save to IndexedDB</button>
                <button onclick="runCode()" class="secondary">‚ñ∂Ô∏è Run Code</button>
                <button onclick="clearCode()" class="danger">üóëÔ∏è Clear</button>
            </div>
        </div>

        <div class="panel">
            <h2>üìÇ Stored Files</h2>
            <ul id="file-list">
                <li style="color: #999; border: none;">No files yet - save code.py to begin</li>
            </ul>
            <div class="button-group">
                <button onclick="refreshFiles()" class="secondary">üîÑ Refresh</button>
                <button onclick="exportProject()" class="secondary">üì• Export Project</button>
                <button onclick="importProject()" class="secondary">üì§ Import Project</button>
                <button onclick="clearAllFiles()" class="danger">üóëÔ∏è Clear All</button>
            </div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>üñ•Ô∏è Console Output</h2>
        <div id="console">Initializing CircuitPython...</div>
        <div class="button-group">
            <button onclick="clearConsole()" class="secondary">Clear Console</button>
        </div>
    </div>

    <div id="status"></div>

    <input type="file" id="import-file" style="display: none;" accept=".json" onchange="handleImportFile(event)">

    <script type="module">
        import { loadCircuitPython } from './circuitpython.mjs';

        let ctpy = null;

        // Console output handling
        function log(message, type = 'normal') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå ' : type === 'success' ? '‚úÖ ' : '';
            console.textContent += `[${timestamp}] ${prefix}${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            setTimeout(() => {
                status.textContent = '';
                status.className = 'status';
            }, 5000);
        }

        // Initialize CircuitPython with IndexedDB persistence
        async function init() {
            try {
                log('Loading CircuitPython WASM module...');

                ctpy = await loadCircuitPython({
                    heapsize: 2 * 1024 * 1024,  // 2MB heap
                    verbose: true,               // Show initialization logs
                    filesystem: 'indexeddb',     // Enable persistent storage
                    autoRun: false,              // Don't auto-run yet
                    stdout: (text) => log(text),
                    stderr: (text) => log(text, 'error')
                });

                log('‚úÖ CircuitPython initialized!', 'success');
                log('‚úÖ IndexedDB filesystem ready!', 'success');

                // Refresh file list
                await refreshFiles();

                // Check if code.py exists and load it
                if (ctpy.filesystem) {
                    const files = await ctpy.filesystem.listFiles();
                    const codeFile = files.find(f => f.path === '/code.py');
                    if (codeFile) {
                        const content = await ctpy.filesystem.readFile('/code.py');
                        const text = new TextDecoder().decode(content);
                        document.getElementById('editor').value = text;
                        log('Loaded code.py from IndexedDB');
                    }
                }

                showStatus('CircuitPython ready! Files persist across page reloads.', 'success');

            } catch (error) {
                log(`Failed to initialize: ${error}`, 'error');
                showStatus('Failed to initialize CircuitPython', 'error');
                console.error(error);
            }
        }

        // Save code to IndexedDB
        window.saveCode = async function() {
            if (!ctpy || !ctpy.filesystem) {
                showStatus('IndexedDB not available', 'error');
                return;
            }

            try {
                const code = document.getElementById('editor').value;
                await ctpy.saveFile('/code.py', code);
                log('Saved code.py to IndexedDB', 'success');
                showStatus('File saved successfully!', 'success');
                await refreshFiles();
            } catch (error) {
                log(`Save failed: ${error}`, 'error');
                showStatus('Failed to save file', 'error');
            }
        };

        // Run the code
        window.runCode = function() {
            if (!ctpy) {
                showStatus('CircuitPython not initialized', 'error');
                return;
            }

            try {
                log('--- Running code.py ---');
                const code = document.getElementById('editor').value;

                // Write to VFS (Emscripten filesystem)
                ctpy.FS.writeFile('/code.py', code);

                // Run the code
                ctpy.runFile('/code.py');

                log('--- Execution complete ---', 'success');
                showStatus('Code executed successfully!', 'success');
            } catch (error) {
                log(`Execution failed: ${error.message}`, 'error');
                showStatus('Execution failed - see console', 'error');
            }
        };

        // Refresh file list
        window.refreshFiles = async function() {
            if (!ctpy || !ctpy.filesystem) {
                return;
            }

            try {
                const files = await ctpy.filesystem.listFiles();
                const fileList = document.getElementById('file-list');

                if (files.length === 0) {
                    fileList.innerHTML = '<li style="color: #999; border: none;">No files stored</li>';
                    return;
                }

                fileList.innerHTML = files.map(file => `
                    <li>
                        <span class="file-name">${file.path}</span>
                        <span class="file-size">${formatBytes(file.size)}</span>
                    </li>
                `).join('');

            } catch (error) {
                log(`Failed to refresh files: ${error}`, 'error');
            }
        };

        // Export project
        window.exportProject = async function() {
            if (!ctpy || !ctpy.filesystem) {
                showStatus('IndexedDB not available', 'error');
                return;
            }

            try {
                const blob = await ctpy.filesystem.exportProject();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `circuitpython-project-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showStatus('Project exported!', 'success');
                log('Project exported to JSON file', 'success');
            } catch (error) {
                log(`Export failed: ${error}`, 'error');
                showStatus('Export failed', 'error');
            }
        };

        // Import project
        window.importProject = function() {
            document.getElementById('import-file').click();
        };

        window.handleImportFile = async function(event) {
            if (!ctpy || !ctpy.filesystem) {
                showStatus('IndexedDB not available', 'error');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            try {
                await ctpy.filesystem.importProject(file);
                showStatus('Project imported!', 'success');
                log('Project imported from JSON file', 'success');

                // Refresh the file list and sync to VFS
                await refreshFiles();
                await ctpy.filesystem.syncToVFS(ctpy._module);

                // Load code.py if it exists
                const files = await ctpy.filesystem.listFiles();
                const codeFile = files.find(f => f.path === '/code.py');
                if (codeFile) {
                    const content = await ctpy.filesystem.readFile('/code.py');
                    const text = new TextDecoder().decode(content);
                    document.getElementById('editor').value = text;
                }
            } catch (error) {
                log(`Import failed: ${error}`, 'error');
                showStatus('Import failed', 'error');
            }

            // Reset file input
            event.target.value = '';
        };

        // Clear all files
        window.clearAllFiles = async function() {
            if (!ctpy || !ctpy.filesystem) {
                showStatus('IndexedDB not available', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete all stored files? This cannot be undone.')) {
                return;
            }

            try {
                await ctpy.filesystem.clear();
                await refreshFiles();
                showStatus('All files cleared', 'success');
                log('All files cleared from IndexedDB', 'success');
            } catch (error) {
                log(`Clear failed: ${error}`, 'error');
                showStatus('Failed to clear files', 'error');
            }
        };

        // Clear code editor
        window.clearCode = function() {
            if (confirm('Clear the code editor?')) {
                document.getElementById('editor').value = '';
            }
        };

        // Clear console
        window.clearConsole = function() {
            document.getElementById('console').textContent = '';
        };

        // Format bytes
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
